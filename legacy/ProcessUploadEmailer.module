<?php
/**
 * A²Fab Lab Uploads Emailer
 *
 * Developed for the A² Fab Lab at the University of Florida.
 * Provides an interface for the manager to send autogenerated emails to the user when the cost/time estimation is done.
 * 
 * Thomas R Storey, 2015
 * Licensed under MIT License, see LICENSE.TXT
 * 
 * http://fablab.arts.ufl.edu
 * https://github.com/UF-Asq-Fab-Lab
 *
 */
class ProcessUploadEmailer extends Process implements ConfigurableModule{
  
  protected $form;
  protected $page; 
  protected $id;
  protected $data;

  public static function getModuleInfo() {
    return array(
      'title' => 'Upload Emailer',
      'summary' => 'Emails the manager when a file is confirmed for printing.',
      'version' => 100,
      'permanent' => false,
      'requires' => array('UploadSystem>=1.0.0'),
      'permission' => 'admin-upload'
      );
  }

  public static function getDefaultConfig(){
    return array(
      'email' => array(
        'type' => 'InputfieldEmail',
        'value' => 'managerEmail@host.com',
        'label' => 'Please provide the contact email for the upload manager.'
        ),
      'email_message' => array(
        'type' => 'InputfieldText',
        'value' => 'bla bla bla',
        'label' => 'This is the default message. Customize. Make sure to add the calculated price and estimated pickup time.'
        )
      );
  }

  public function init() {
    $this->page = $this->pages->get($this->id);
    $this->data = wire('modules')->getModuleConfigData("ProcessUploadEmailer");
    parent::init();
  }

  public function ___execute() {
    $this->form = $this->modules->get('InputfieldForm');
    $this->form = $this->buildForm($this->form);
    if(wire('input')->post->submit) $this->sendEmail();
    return $this->form->render();
  }

  protected function buildForm(InputfieldForm $form) {
    $processconfirmid = wire('modules')->getModuleID("ProcessUploadConfirm");
    $confirmpage = wire('pages')->get("process=$processconfirmid");
    $url = $confirmpage->httpUrl . "?confirm=" . wire('page')->hash;
    $field = $this->modules->get('InputfieldTextarea');
    $field->id = "message";
    $field->name = "message";
    $field->label = "Confirmation Request Message";
    $field->value = str_replace("[url]", $url, $this->data["email_message"]);
    $button = $this->modules->get('InputfieldSubmit');
    $button->id = "submit";
    $button->name = "submit";
    $button->label = 'Send Confirmation Request';
    $button->icon = 'paper-plane';
    $form->append($field);
    $form->append($button);
    return $form;
  }

  protected function sendEmail(){
    $page = $this->page;
    //this process will be attached to each upload templated page (file page), so $page->email is the email address of the user
    $mailer = wireMail();
    $emailtouse;
    if($page->email){
      $emailtouse = $page->email;
    } else {
      $emailtouse = "storey.thomas@gmail.com";
    }
    $mailer->to($emailtouse, wire('page')->username)->from($this->data['email'], 'UF A² Fab Lab Uploads Manager');
    $mailer->subject("Print Confirmation Request")->body($this->data['email_message']);
    $recipients = $mailer->send();
    return $recipients;
  }

  public static function getModuleConfigInputFields(array $data) {
    $inputfields = new InputFieldWrapper();
    $defaults = self::getDefaultConfig();

    foreach ($defaults as $key => $value) {
        $field = wire('modules')->get($value['type']);
        $field->name = $key;
        $field->label = $value['label'];
        if(isset($data[$key])){
          $field->value = $data[$key];
        } else {
          $field->value = $value['value'];
        }
        $inputfields->add($field);
    }
    return $inputfields;
  }

}
?>