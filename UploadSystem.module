<?php

/*
* A² Fab Lab Upload System
* Thomas R. Storey (trstorey.sysreturn.net)
* contact: storey.thomas@gmail.com
* 2/12/15
* Makes an admin page to manage the upload system and uploaded files
*/

    class UploadSystem extends Process implements Module, ConfigurableModule {

        public static function getModuleInfo() {
            return array(
                'title' => 'A² Fab Lab Upload System',
                'summary' => 'Makes an admin page to manage the upload system and uploaded files.',
                'version' => 1,
                'autoload' => true 
            );
        }

        public function __construct() {
            // optionally set our default values before ProcessWire configures the module
            $this->fullname = '';
            $this->email = '';
        }

        public function init() {
            // you can now assume that your configuration data has been populated to the module
            // meaning you can access $this->fullname; or $this->email; in any of your module's functions

            if(isset($_SERVER['REQUEST_URI']) && strpos($_SERVER['REQUEST_URI'], $this->upload_page_url) !== false) {
                //$this->addHook('ProcessPageView::execute', $this, 'addUploadForm'); 
                $this->addHookBefore('Page::render', $this, 'prependUploadForm');
            }


        }

        public function ___install() {
            $page = $this->getInstalledPage();
            $this->message("Installed to {$page->path}"); 
        }

        public function ___uninstall() {
            $page = $this->getInstalledPage();  
            if($page->id) { 
                $this->message("Removed {$page->path}");
                $this->pages->delete($page); 
            }
        }

        public function addUploadForm(HookEvent $event) {

            /*
                Here's the idea: use this to insert the upload form data into any page
                check the page to see if it has some kind of tag, category...something that can be attached
                to a sub-page template from the page->edit screen.
            */
            //$event->return = str_ireplace("[upload_form]", $this->form_markup, $event->return); 
        }

        public function prependUploadForm(HookEvent $event) {
            $event->arguments('options')['prependFile'] = $this->upload_form_filepath;
        }

        protected function getInstalledPage() {
            $parent = $this->pages->get("name=module,parent=".$this->config->adminRootPageID); 
            $page = $parent->child("name=uploadsystem"); 

            if(!$page->id) {    
                $page = new Page();
                $page->parent = $parent; 
                $page->template = $this->templates->get('admin');
                $page->name = "uploadsystem"; 
                $page->title = "Upload Management Page";
                //$page->addStatus(Page::statusHidden);
                $page->process = $this; 
                $page->sort = $parent->numChildren;
                $page->save();
            }
            return $page;   
        }

        public static function getModuleConfigInputfields(array $data) {
            $inputfields = new InputfieldWrapper(); 

            // ask for form markup
            $field = wire('modules')->get('InputfieldText');
            $field->name = 'upload_form_filepath';
            $field->label = "Upload form markup";
            if(isset($data['upload_form_filepath'])) $field->value = $data['upload_form_filepath'];
            $inputfields->add($field); 

            // ask for upload page url
            $field = wire('modules')->get('InputfieldText');
            $field->name = 'upload_page_url';
            $field->label = "Upload page URL";
            if(isset($data['upload_page_url'])) $field->value = $data['upload_page_url'];
            $inputfields->add($field); 

            // ask for an email address
            $field = wire('modules')->get('InputfieldEmail'); 
            $field->name = 'email';
            $field->label = 'Upload manager email address';
            if(isset($data['email'])) $field->value = $data['email'];
            $inputfields->add($field);

            return $inputfields; 
        }
    }
?>