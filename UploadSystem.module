<?php

/*
* A² Fab Lab Upload System
* Thomas R. Storey (trstorey.sysreturn.net)
* contact: storey.thomas@gmail.com
* 2/12/15
* Makes an admin page to manage the upload system and uploaded files
*/

    class UploadSystem extends Process implements Module, ConfigurableModule {

        public static function getModuleInfo() {
            return array(
                'title' => 'A² Fab Lab Upload System',
                'summary' => 'Makes an admin page to manage the upload system and uploaded files.',
                'version' => 2,
                'autoload' => true 
            );
        } 

        public function __construct() {
            // optionally set our default values before ProcessWire configures the module
            // previously, set $this-> tableName, etc to values in $defaults array
            $this->defaults = array(
                "tableName" => "uploadsystem_options",
                "tableColumns" => "printer_name material_name color",
                "tableLabel" => "UploadSystem Options Table",
                "tableTags" => "upload",
                "pageName" => "uploadsystem_management",
                "pageTitle" => "Upload System Management Page"
            );   
        }

        public function init() {
            // you can now assume that your configuration data has been populated to the module
            // meaning you can access $this->fullname; or $this->email; in any of your module's functions

            if(isset($_SERVER['REQUEST_URI']) && strpos($_SERVER['REQUEST_URI'], $this->upload_page_url) !== false) {
                $this->addHookBefore('PageRender::renderPage', $this, 'prependUploadHandler');
                $this->addHook('ProcessPageView::execute', $this, 'addUploadForm');
            }


        }

        public function getPageTable($ptName, $ptCols, $ptLabel, $ptTags, $pid){

            $f = $this->fields->get("name={$ptName}");

            if(!$f->id){
               $fieldsArray = explode(" ", $ptCols);

                $f = new Field();
                $f->type = wire('modules')->get('FieldtypePageTable');
                $f->name = $ptName;
                $f->label = $ptLabel;
                $f->tags = $ptTags;
                $f->parent_id = $pid;
                foreach ($fieldsArray as $field) {
                    $f->columns .= $field . "\n";
                }

                //make fieldgroup for template
                $ptFG = $this->fieldgroups->get("name=pagetable_$ptName");
                if(!$ptFG->id){
                    $ptFG = new Fieldgroup();
                    $ptFG->name = "pagetable_$ptName";
                    $ptFG->append($this->fields->get("name=title"));
                }
                
                //Add fields to fieldgroup
                foreach($fieldsArray as $fieldName) {
                    //make column fields if they do not exist
                    $field = $this->fields->get($fieldName);
                    if(!$field->id){
                        //field does not exist
                        $field = new Field();
                        $field->name = $fieldName;
                        $field->type = wire('modules')->get('FieldtypeText');
                        $field->label = "$ptName $fieldName";
                        $field->save();
                        $ptFG->append($field);
                    } else {
                        //field does exist, so add it
                      if(!$ptFG->getField($field->name)){
                        $ptFG->append($field); 
                      } 
                    }   
                }
                
                $ptFG->save();

                //make template
                $ptTemplate = $this->templates->get("name=pagetable_$ptName");
                if(!$ptTemplate->id){
                    $ptTemplate = new Template();
                    $ptTemplate->name = "pagetable_$ptName";
                    $ptTemplate->flags = 0;
                    $ptTemplate->noChildren = 0;
                    $ptTemplate->noParents = 0;
                    $ptTemplate->noGlobal = 1;
                    $ptTemplate->slashUrls = 1;
                    $ptTemplate->fieldgroup = $ptFG;
                    $ptTemplate->save();
                }
                
                $f->template_id = $ptTemplate->id;

                $f->save(); 
            }

            return $f;

        }

        public function ___install() {
           $this->defaults = array(
                "tableName" => "uploadsystem_options",
                "tableColumns" => "printer_name material_name color",
                "tableLabel" => "UploadSystem Options Table",
                "tableTags" => "upload",
                "pageName" => "uploadsystem_management",
                "pageTitle" => "Upload System Management Page"
            );
            $page = $this->getInstalledPage(false);
            $this->message("Installed to {$page->path}");
        }

        /**
        * uninstall - delete everything created by the module: module page, 
        *                                                      page template, 
        *                                                      page template fieldgroup, 
        *                                                      pagetable (page template field)
        *                                                      pagetable template
        *                                                      pagetable fieldgroup
        *                                                      pagetable page fields
        *
        *
        **/

        public function ___uninstall() {
            $page = $this->getInstalledPage(true);

            $template = $page->template;
            $pt = $this->getPageTable($this->defaults['tableName'], $this->defaults['tableColumns'], $this->defualts['tableLabel'], $this->defaults['tableTags'], $page->id);
            $ptTemplate = $this->templates->get($pt->template_id);

            //REMOVE PAGE AND CHILDREN
            if($page->id) {
                if(count($page->children)){
                    foreach ($page->children as $child) {
                        $this->message("Removed page table entry {$child->path}");
                        $this->pages->delete($child); 
                    }
                } 
                $this->message("Removed {$page->path}");
                $this->pages->delete($page, true); 
            }
            //REMOVE PAGE TEMPLATE AND FIELDGROUP
            if($template->id){
                $template->flags = Template::flagSystemOverride;
                $template->flags = 0;
                $template->save();
                $fgname = $template->fieldgroup->name;
                if ($template->getNumPages() > 0) {
                    throw new WireException("Can't uninstall because template is used by some pages.");
                } else {
                    $this->message("Remove: page template: {$template->name}");
                    $this->templates->delete($template);
                    $this->message("Remove: page template fieldgroup: {$fgname}");
                    $this->fieldgroups->delete($this->fieldgroups->get("name=$fgname"));
                }
            }
            //REMOVE CHILD TEMPLATE (PAGE TABLE ENTRY TEMPLATE AND FIELDGROUP)
            if($ptTemplate->id){
                $ptTemplate->flags = Template::flagSystemOverride;
                $ptTemplate->flags = 0;
                $ptTemplate->save();
                if($ptTemplate->getNumPages() > 0){
                    throw new WireException("Can't uninstall because template is used by some pages.");
                } else {
                    $fgname = $ptTemplate->fieldgroup->name;
                    $this->message("Remove: pagetable template: {$ptTemplate->name}");
                    $this->templates->delete($ptTemplate);
                    $this->message("Remove: pagetable template fieldgroup: {$fgname}");
                    $this->fieldgroups->delete($this->fieldgroups->get($fgname));
                }
            }
            //REMOVE PAGETABLE FIELD
            $field = $this->fields->get("name={$this->defaults['tableName']}");
            if($field->id){
                $this->message("Remove: pagetable: {$field->name}");
                $this->fields->delete($field);
            }
            //REMOVE PAGETABLE ENTRY FIELDS
            $fieldsArray = explode(' ', $this->defaults['tableColumns']);
            foreach ($fieldsArray as $field) {
                if($this->fields->get("name=$field")){
                    $this->message("Remove: pagetable field: {$field->name}");
                    $this->fields->delete($this->fields->get($field));
                }
            }
        }

        public function addUploadForm(HookEvent $event) {
            $markup = file_get_contents($this->upload_form_filepath);
            $event->return = str_ireplace("[upload_form]", $markup, $event->return); 
        }

        public function prependUploadHandler(HookEvent $event) {
            $render = $event->arguments(0);

            $page = $render->object;

            $newOptions = array(
                'prependFile' => $this->upload_handler_filepath
                );
            $render->arguments(0, $newOptions);
        }

        protected function getInstalledPage($uninstall) {
            $parent = $this->pages->get("name=module,parent=".$this->config->adminRootPageID); 
            $page = $parent->child("name={$this->defaults['pageName']}"); 

            if(!$page->id && !$uninstall) {    
                $page = new Page();
                $page->parent = $parent; 


                $pageTable = $this->fields->get("name={$this->defaults['tableName']}");
                if(!$pageTable->id){
                    $pageTable = $this->getPageTable($this->defaults['tableName'], $this->defaults['tableColumns'], $this->defaults['tableLabel'], $this->defaults['tableTags'], $page->id);
                }

                $pageFG = $this->fieldgroups->get("name={$this->defaults['pageName']}_FG");
                if(!$pageFG->id){
                    $pageFG = new Fieldgroup();
                    $pageFG->name = "{$this->defaults['pageName']}_FG";
                    $pageFG->append($this->fields->get("name=title"));
                    $pageFG->append($this->fields->get("name=process"));
                    $pageFG->append($pageTable);
                    $pageFG->save(); 
                }
                
                $pageTemplate = $this->templates->get("name={$this->defaults['pageName']}_T");
                if(!$pageTemplate->id){
                   $pageTemplate = new Template();
                    $pageTemplate->name = "{$this->defaults['pageName']}_T";
                    $pageTemplate->flags = 0;
                    $pageTemplate->noChildren = 0;
                    $pageTemplate->noParents = 0;
                    $pageTemplate->noGlobal = 1;
                    $pageTemplate->slashUrls = 1;
                    $pageTemplate->fieldgroup = $pageFG;
                    $pageTemplate->save(); 
                }

                $page->template = $pageTemplate;
                $page->name = $this->defaults['pageName']; 
                $page->title = $this->defaults['pageTitle'];
                $page->process = $this; 
                $page->sort = $parent->numChildren;
                $page->save();
            }
            return $page;   
        }



        public static function getModuleConfigInputfields(array $data) {
            $inputfields = new InputfieldWrapper();

            // ask for form markup
            $field = wire('modules')->get('InputfieldText');
            $field->name = 'upload_form_filepath';
            $field->label = "Upload form markup";
            if(isset($data['upload_form_filepath'])) $field->value = $data['upload_form_filepath'];
            $inputfields->add($field);

            // ask for upload handler
            $field = wire('modules')->get('InputfieldText');
            $field->name = 'upload_handler_filepath';
            $field->label = "Upload handler file";
            if(isset($data['upload_handler_filepath'])) $field->value = $data['upload_handler_filepath'];
            $inputfields->add($field); 

            // ask for upload page url
            $field = wire('modules')->get('InputfieldText');
            $field->name = 'upload_page_url';
            $field->label = "Upload page URL";
            if(isset($data['upload_page_url'])) $field->value = $data['upload_page_url'];
            $inputfields->add($field); 

            // ask for an email address
            $field = wire('modules')->get('InputfieldEmail'); 
            $field->name = 'email';
            $field->label = 'Upload manager email address';
            if(isset($data['email'])) $field->value = $data['email'];
            $inputfields->add($field);

            return $inputfields; 
        }
    }
?>